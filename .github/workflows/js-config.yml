on:
  workflow_call:
    inputs:
      repo:
        type: string
        default: ${{ github.repository }}
    outputs:
      node:
        value: ${{ jobs.config.outputs.node }}
      integration:
        value: ${{ jobs.config.outputs.integration }}
      browser:
        value: ${{ jobs.config.outputs.browser }}
      desktop:
        value: ${{ jobs.config.outputs.desktop }}
      microservices:
        value: ${{ jobs.config.outputs.microservices }}
    secrets:
      TOKEN:
        required: true
jobs:
  config:
    runs-on: ubuntu-latest
    outputs:
      node: ${{ steps.config.outputs.node }}
      integration: ${{ steps.config.outputs.integration }}
      browser: ${{ steps.config.outputs.browser }}
      desktop: ${{ steps.config.outputs.desktop }}
      microservices: ${{ steps.config.outputs.microservices }}
    steps:
      - name: Checkout
        uses: Geode-solutions/actions/install/checkout@master
        with:
          token: ${{ secrets.TOKEN }}
      - name: Read config
        id: config
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs').promises;
            const defaults = {
              node: true,
              integration: false,
              browser: false,
              desktop: false,
              microservices: "microservices"
            };
            const fullRepo = '${{ inputs.repo }}'
            const repoName = fullRepo.split('/')[1];
            const configFile = '.github/workflows/config.json';
            const outputFile = `${repoName}-js-config.json`;
            const outputConfig = {};
            try {
              // Attempt to read and parse the config file
              const configData = await fs.readFile(configFile, 'utf8');
              const config = JSON.parse(configData);

              // Process each key
              for (const key of Object.keys(defaults)) {
                let value;
                if (config.hasOwnProperty(key)) {
                  value = config[key] !== null ? config[key] : 'null';
                  core.info(`${key}: ${value} (from config)`);
                } else {
                  value = defaults[key];
                  core.info(`${key}: ${value} (default)`);
                }
                core.setOutput(key, value);
                outputConfig[key] = value;
              }
            } catch (error) {
              // If config file doesn't exist or fails to parse, use defaults
              core.info(`Config file ${configFile} not found or invalid, using defaults: ${error.message}`);
              for (const key of Object.keys(defaults)) {
                core.info(`${key}: ${defaults[key]} (default)`);
                core.setOutput(key, defaults[key]);
                outputConfig[key] = defaults[key];
              }
            }
            await fs.writeFile(outputFile, JSON.stringify(outputConfig));
            core.info(`Created ${outputFile} with processed configuration`);
            core.setOutput('repo', repoName);
      - name: Upload processed config as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.config.outputs.repo }}-js-config
          path: ${{ steps.config.outputs.repo }}-js-config.json
